# AWS SSM Parameter Store & Secrets Manager Integration Guide

## Table of Contents
1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Choosing Between SSM Parameter Store and Secrets Manager](#choosing-between-ssm-parameter-store-and-secrets-manager)
4. [Implementation Steps](#implementation-steps)
5. [Terraform Configuration](#terraform-configuration)
6. [ECS Integration](#ecs-integration)
7. [Application Code Changes](#application-code-changes)
8. [Testing and Validation](#testing-and-validation)
9. [Security Best Practices](#security-best-practices)
10. [Monitoring and Rotation](#monitoring-and-rotation)
11. [Troubleshooting](#troubleshooting)

---

## Overview

This guide demonstrates how to integrate AWS Systems Manager (SSM) Parameter Store and AWS Secrets Manager into your 3-tier architecture to securely manage sensitive configuration data such as database passwords, API keys, and other secrets.

### Current State
Your project currently uses hardcoded values in:
- `terraform.tfvars` for database passwords
- Environment variables in ECS task definitions
- `.env` files for local development

### Target State
After implementation:
- Database passwords stored in AWS Secrets Manager
- Application configuration in SSM Parameter Store
- ECS tasks automatically retrieve secrets at runtime
- No sensitive data in code or configuration files

**[SCREENSHOT PLACEHOLDER: Before/After Architecture Comparison]**

---

## Prerequisites

### Required Tools
- AWS CLI v2.x configured with appropriate permissions
- Terraform v1.5+
- Access to AWS Console with IAM permissions for:
  - SSM Parameter Store
  - AWS Secrets Manager
  - IAM role/policy management
  - ECS task definition updates

### Required IAM Permissions
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameter",
                "ssm:GetParameters",
                "ssm:PutParameter",
                "ssm:DeleteParameter",
                "secretsmanager:CreateSecret",
                "secretsmanager:GetSecretValue",
                "secretsmanager:UpdateSecret",
                "secretsmanager:DeleteSecret",
                "iam:CreateRole",
                "iam:AttachRolePolicy",
                "iam:CreatePolicy"
            ],
            "Resource": "*"
        }
    ]
}
```

**[SCREENSHOT PLACEHOLDER: IAM Policy Configuration in AWS Console]**

---

## Choosing Between SSM Parameter Store and Secrets Manager

### SSM Parameter Store
**Best for:**
- Application configuration (non-secret)
- Environment variables
- Feature flags
- Database connection strings (without passwords)

**Characteristics:**
- Free tier: 10,000 parameters
- Standard parameters: Up to 4KB
- Advanced parameters: Up to 8KB
- No automatic rotation
- Lower cost

### AWS Secrets Manager
**Best for:**
- Database passwords
- API keys
- OAuth tokens
- Any credential requiring rotation

**Characteristics:**
- $0.40 per secret per month
- $0.05 per 10,000 API calls
- Automatic rotation capability
- Integration with RDS, Redshift, DocumentDB
- Cross-region replication

### Recommended Approach for This Project

| Secret Type | Service | Parameter Name | Justification |
|-------------|---------|----------------|---------------|
| Database Master Password | Secrets Manager | `/myapp/database/master-password` | Supports automatic rotation |
| Database Username | SSM Parameter Store | `/myapp/database/username` | Static configuration |
| Database Host | SSM Parameter Store | `/myapp/database/host` | Generated by Terraform |
| JWT Secret | Secrets Manager | `/myapp/jwt/secret` | Security-critical |
| Frontend Config | SSM Parameter Store | `/myapp/frontend/api-url` | Non-sensitive configuration |

**[SCREENSHOT PLACEHOLDER: AWS Console showing Parameter Store and Secrets Manager side by side]**

---

## Implementation Steps

### Phase 1: Create Secrets and Parameters
### Phase 2: Update Terraform Configuration
### Phase 3: Modify ECS Task Definitions
### Phase 4: Update Application Code
### Phase 5: Test and Validate

---

## Terraform Configuration

### 1. Create SSM Parameters

Create `ssm.tf` in your Terraform directory:

```hcl
# SSM Parameter Store for non-sensitive configuration
resource "aws_ssm_parameter" "database_host" {
  name  = "/myapp/database/host"
  type  = "String"
  value = aws_db_instance.database_master.endpoint

  tags = {
    Environment = "production"
    Project     = "3tier-app"
  }
}

resource "aws_ssm_parameter" "database_username" {
  name  = "/myapp/database/username"
  type  = "String"
  value = var.db_username

  tags = {
    Environment = "production"
    Project     = "3tier-app"
  }
}

resource "aws_ssm_parameter" "database_name" {
  name  = "/myapp/database/name"
  type  = "String"
  value = var.db_name

  tags = {
    Environment = "production"
    Project     = "3tier-app"
  }
}

resource "aws_ssm_parameter" "frontend_api_url" {
  name  = "/myapp/frontend/api-url"
  type  = "String"
  value = "http://${aws_lb.internal_alb.dns_name}:5000"

  tags = {
    Environment = "production"
    Project     = "3tier-app"
  }
}
```

### 2. Create Secrets Manager Secrets

Add to `ssm.tf`:

```hcl
# Secrets Manager for sensitive data
resource "aws_secretsmanager_secret" "database_password" {
  name                    = "/myapp/database/master-password"
  description             = "Master database password for 3-tier application"
  recovery_window_in_days = 7

  tags = {
    Environment = "production"
    Project     = "3tier-app"
  }
}

resource "aws_secretsmanager_secret_version" "database_password" {
  secret_id     = aws_secretsmanager_secret.database_password.id
  secret_string = var.db_password
}

resource "aws_secretsmanager_secret" "jwt_secret" {
  name                    = "/myapp/jwt/secret"
  description             = "JWT signing secret for authentication"
  recovery_window_in_days = 7

  tags = {
    Environment = "production"
    Project     = "3tier-app"
  }
}

resource "aws_secretsmanager_secret_version" "jwt_secret" {
  secret_id     = aws_secretsmanager_secret.jwt_secret.id
  secret_string = var.jwt_secret
}
```

### 3. IAM Roles and Policies

Add to `ssm.tf`:

```hcl
# IAM policy for ECS tasks to access SSM and Secrets Manager
resource "aws_iam_policy" "ecs_secrets_policy" {
  name        = "ecs-secrets-access-policy"
  description = "Policy for ECS tasks to access SSM Parameter Store and Secrets Manager"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "ssm:GetParameter",
          "ssm:GetParameters",
          "ssm:GetParametersByPath"
        ]
        Resource = [
          "arn:aws:ssm:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:parameter/myapp/*"
        ]
      },
      {
        Effect = "Allow"
        Action = [
          "secretsmanager:GetSecretValue"
        ]
        Resource = [
          aws_secretsmanager_secret.database_password.arn,
          aws_secretsmanager_secret.jwt_secret.arn
        ]
      }
    ]
  })
}

# Attach policy to existing ECS task execution role
resource "aws_iam_role_policy_attachment" "ecs_secrets_policy_attachment" {
  role       = aws_iam_role.ecs_task_execution_role.name
  policy_arn = aws_iam_policy.ecs_secrets_policy.arn
}

# Data sources for current AWS account info
data "aws_region" "current" {}
data "aws_caller_identity" "current" {}
```

### 4. Update Variables

Add to `variables.tf`:

```hcl
variable "jwt_secret" {
  description = "JWT signing secret"
  type        = string
  sensitive   = true
}
```

Add to `terraform.tfvars`:

```hcl
jwt_secret = "your-super-secret-jwt-key-here"
```

**[SCREENSHOT PLACEHOLDER: Terraform plan output showing SSM and Secrets Manager resources]**

---

## ECS Integration

### 1. Update Backend Task Definition

Modify your `ecs.tf` file to reference secrets:

```hcl
resource "aws_ecs_task_definition" "backend_task" {
  family                   = "backend-task"
  network_mode             = "bridge"
  requires_compatibilities = ["EC2"]
  execution_role_arn       = aws_iam_role.ecs_task_execution_role.arn
  task_role_arn           = aws_iam_role.ecs_task_execution_role.arn

  container_definitions = jsonencode([
    {
      name  = "backend"
      image = "${aws_ecr_repository.backend_repo.repository_url}:latest"
      
      portMappings = [
        {
          containerPort = 5000
          protocol      = "tcp"
        }
      ]

      # Environment variables from SSM Parameter Store
      environment = [
        {
          name  = "NODE_ENV"
          value = "production"
        }
      ]

      # Secrets from SSM Parameter Store and Secrets Manager
      secrets = [
        {
          name      = "DB_HOST"
          valueFrom = aws_ssm_parameter.database_host.arn
        },
        {
          name      = "DB_USER"
          valueFrom = aws_ssm_parameter.database_username.arn
        },
        {
          name      = "DB_NAME"
          valueFrom = aws_ssm_parameter.database_name.arn
        },
        {
          name      = "DB_PASSWORD"
          valueFrom = aws_secretsmanager_secret.database_password.arn
        },
        {
          name      = "JWT_SECRET"
          valueFrom = aws_secretsmanager_secret.jwt_secret.arn
        }
      ]

      logConfiguration = {
        logDriver = "awslogs"
        options = {
          "awslogs-group"         = aws_cloudwatch_log_group.backend_logs.name
          "awslogs-region"        = data.aws_region.current.name
          "awslogs-stream-prefix" = "ecs"
        }
      }

      essential = true
    }
  ])
}
```

### 2. Update Frontend Task Definition (if needed)

```hcl
resource "aws_ecs_task_definition" "frontend_task" {
  family                   = "frontend-task"
  network_mode             = "bridge"
  requires_compatibilities = ["EC2"]
  execution_role_arn       = aws_iam_role.ecs_task_execution_role.arn

  container_definitions = jsonencode([
    {
      name  = "frontend"
      image = "${aws_ecr_repository.frontend_repo.repository_url}:latest"
      
      portMappings = [
        {
          containerPort = 80
          protocol      = "tcp"
        }
      ]

      # Environment variables for frontend configuration
      secrets = [
        {
          name      = "API_URL"
          valueFrom = aws_ssm_parameter.frontend_api_url.arn
        }
      ]

      logConfiguration = {
        logDriver = "awslogs"
        options = {
          "awslogs-group"         = aws_cloudwatch_log_group.frontend_logs.name
          "awslogs-region"        = data.aws_region.current.name
          "awslogs-stream-prefix" = "ecs"
        }
      }

      essential = true
    }
  ])
}
```

**[SCREENSHOT PLACEHOLDER: ECS Task Definition showing secrets configuration in AWS Console]**

---

## Application Code Changes

### 1. Backend Node.js Configuration

Update your `Backend/config/database.js`:

```javascript
// config/database.js
const mysql = require('mysql2/promise');

const dbConfig = {
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
};

// Validate required environment variables
const requiredEnvVars = ['DB_HOST', 'DB_USER', 'DB_PASSWORD', 'DB_NAME'];
const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);

if (missingVars.length > 0) {
  console.error('Missing required environment variables:', missingVars);
  process.exit(1);
}

console.log('Database configuration loaded from environment variables');
console.log('DB_HOST:', process.env.DB_HOST);
console.log('DB_USER:', process.env.DB_USER);
console.log('DB_NAME:', process.env.DB_NAME);
// Note: Never log passwords

const pool = mysql.createPool(dbConfig);

module.exports = pool;
```

### 2. JWT Configuration

Update your JWT configuration to use the secret from environment:

```javascript
// config/auth.js
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET;

if (!JWT_SECRET) {
  console.error('JWT_SECRET environment variable is required');
  process.exit(1);
}

const generateToken = (payload) => {
  return jwt.sign(payload, JWT_SECRET, { expiresIn: '24h' });
};

const verifyToken = (token) => {
  return jwt.verify(token, JWT_SECRET);
};

module.exports = {
  generateToken,
  verifyToken
};
```

### 3. Optional: Runtime Secret Fetching

For scenarios where you need to fetch secrets at runtime (e.g., for secret rotation):

```javascript
// utils/secretsManager.js
const AWS = require('aws-sdk');

const secretsManager = new AWS.SecretsManager({
  region: process.env.AWS_REGION || 'eu-west-2'
});

const getSecret = async (secretName) => {
  try {
    const data = await secretsManager.getSecretValue({ SecretId: secretName }).promise();
    
    if ('SecretString' in data) {
      return data.SecretString;
    } else {
      // Handle binary secret
      const buff = Buffer.from(data.SecretBinary, 'base64');
      return buff.toString('ascii');
    }
  } catch (error) {
    console.error(`Error retrieving secret ${secretName}:`, error);
    throw error;
  }
};

const getParameter = async (parameterName) => {
  const ssm = new AWS.SSM({
    region: process.env.AWS_REGION || 'eu-west-2'
  });

  try {
    const data = await ssm.getParameter({
      Name: parameterName,
      WithDecryption: true
    }).promise();
    
    return data.Parameter.Value;
  } catch (error) {
    console.error(`Error retrieving parameter ${parameterName}:`, error);
    throw error;
  }
};

module.exports = {
  getSecret,
  getParameter
};
```

### 4. Update Package Dependencies

Add AWS SDK to your `Backend/package.json`:

```json
{
  "dependencies": {
    "aws-sdk": "^2.1691.0",
    // ... other dependencies
  }
}
```

**[SCREENSHOT PLACEHOLDER: Node.js application logs showing successful secret retrieval]**

---

## Testing and Validation

### 1. Local Testing with AWS CLI

Test parameter retrieval from your local machine:

```bash
# Test SSM Parameter Store
aws ssm get-parameter --name "/myapp/database/host" --region eu-west-2

# Test Secrets Manager
aws secretsmanager get-secret-value --secret-id "/myapp/database/master-password" --region eu-west-2
```

### 2. Bastion Host Testing

SSH into your bastion host and test secret retrieval:

```bash
# SSH to bastion
ssh -i cba_keypair.pem ec2-user@18.133.220.243

# Install AWS CLI if not present
sudo yum install -y aws-cli

# Configure AWS CLI with IAM role or temporary credentials
aws configure

# Test parameter retrieval
aws ssm get-parameter --name "/myapp/database/host" --region eu-west-2

# Test secret retrieval
aws secretsmanager get-secret-value --secret-id "/myapp/database/master-password" --region eu-west-2
```

### 3. ECS Task Validation

Check ECS task logs to verify environment variables are populated:

```bash
# Get running tasks
aws ecs list-tasks --cluster your-cluster-name --region eu-west-2

# Check task logs
aws logs get-log-events \
  --log-group-name /ecs/backend \
  --log-stream-name "ecs/backend/TASK_ID" \
  --region eu-west-2
```

### 4. Database Connection Test

Verify database connectivity with new secret-based authentication:

```bash
# From bastion host, test database connection
mysql -h $(aws ssm get-parameter --name "/myapp/database/host" --query "Parameter.Value" --output text) \
      -u $(aws ssm get-parameter --name "/myapp/database/username" --query "Parameter.Value" --output text) \
      -p$(aws secretsmanager get-secret-value --secret-id "/myapp/database/master-password" --query "SecretString" --output text) \
      -D $(aws ssm get-parameter --name "/myapp/database/name" --query "Parameter.Value" --output text)
```

**[SCREENSHOT PLACEHOLDER: AWS CLI commands showing successful parameter/secret retrieval]**

**[SCREENSHOT PLACEHOLDER: ECS service logs showing environment variables loaded from SSM]**

---

## Security Best Practices

### 1. IAM Principle of Least Privilege

- Grant only necessary permissions to ECS tasks
- Use resource-specific ARNs in IAM policies
- Regularly audit IAM permissions

### 2. Parameter Store Security

```hcl
# Use SecureString for sensitive parameters
resource "aws_ssm_parameter" "secure_config" {
  name  = "/myapp/config/secure-setting"
  type  = "SecureString"
  value = "sensitive-value"
  
  # Use customer-managed KMS key for additional security
  key_id = aws_kms_key.parameter_store_key.arn
}

# KMS key for parameter encryption
resource "aws_kms_key" "parameter_store_key" {
  description             = "KMS key for SSM Parameter Store encryption"
  deletion_window_in_days = 7

  tags = {
    Name = "parameter-store-key"
  }
}
```

### 3. Secrets Manager Security

- Enable automatic rotation when possible
- Use resource-based policies for cross-account access
- Monitor access with CloudTrail

### 4. Network Security

- Ensure ECS tasks run in private subnets
- Use VPC endpoints for SSM and Secrets Manager to avoid internet traffic
- Configure security groups to restrict access

**[SCREENSHOT PLACEHOLDER: CloudTrail logs showing SSM/Secrets Manager access events]**

---

## Monitoring and Rotation

### 1. CloudWatch Monitoring

Set up alarms for secret access:

```hcl
resource "aws_cloudwatch_metric_alarm" "secrets_access_alarm" {
  alarm_name          = "high-secrets-access"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "NumberOfSecrets"
  namespace           = "AWS/SecretsManager"
  period              = "300"
  statistic           = "Sum"
  threshold           = "100"
  alarm_description   = "This metric monitors excessive secrets access"
  alarm_actions       = [aws_sns_topic.alerts.arn]
}
```

### 2. Automatic Secret Rotation

For RDS passwords, enable automatic rotation:

```hcl
resource "aws_secretsmanager_secret_rotation" "database_rotation" {
  secret_id           = aws_secretsmanager_secret.database_password.id
  rotation_lambda_arn = aws_lambda_function.rotation_lambda.arn

  rotation_rules {
    automatically_after_days = 30
  }
}
```

### 3. Parameter Change Notifications

Monitor parameter changes with EventBridge:

```hcl
resource "aws_cloudwatch_event_rule" "parameter_change" {
  name        = "parameter-change-rule"
  description = "Capture parameter changes"

  event_pattern = jsonencode({
    source      = ["aws.ssm"]
    detail-type = ["Parameter Store Change"]
    detail = {
      name = ["/myapp/*"]
    }
  })
}

resource "aws_cloudwatch_event_target" "sns" {
  rule      = aws_cloudwatch_event_rule.parameter_change.name
  target_id = "SendToSNS"
  arn       = aws_sns_topic.alerts.arn
}
```

**[SCREENSHOT PLACEHOLDER: CloudWatch dashboard showing SSM/Secrets Manager metrics]**

---

## Troubleshooting

### Common Issues and Solutions

#### 1. ECS Task Cannot Access Secrets

**Symptoms:**
- ECS tasks fail to start
- Environment variables are empty
- "Access Denied" errors in logs

**Solution:**
```bash
# Check IAM role permissions
aws iam get-role-policy --role-name ecs-task-execution-role --policy-name secrets-policy

# Verify secret ARNs in task definition
aws ecs describe-task-definition --task-definition backend-task --query 'taskDefinition.containerDefinitions[0].secrets'

# Check CloudWatch logs for detailed error messages
aws logs get-log-events --log-group-name /ecs/backend --log-stream-name latest
```

#### 2. Parameter Not Found

**Symptoms:**
- "ParameterNotFound" errors
- Empty environment variables

**Solution:**
```bash
# Verify parameter exists
aws ssm get-parameter --name "/myapp/database/host"

# Check parameter ARN format in Terraform
# Correct format: arn:aws:ssm:region:account:parameter/myapp/database/host
```

#### 3. Secrets Manager Access Issues

**Symptoms:**
- "AccessDenied" when retrieving secrets
- Secrets not populated in ECS

**Solution:**
```bash
# Test secret access with AWS CLI
aws secretsmanager get-secret-value --secret-id "/myapp/database/master-password"

# Check resource-based policies on the secret
aws secretsmanager describe-secret --secret-id "/myapp/database/master-password"
```

#### 4. Local Development Issues

**Symptoms:**
- Application works in ECS but not locally
- Database connection failures in development

**Solution:**
Create a local `.env` file for development:

```bash
# Backend/.env.local
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=localpassword
DB_NAME=mydatabase
JWT_SECRET=local-jwt-secret
```

Update your application to use local env file when not in ECS:

```javascript
// Load environment variables
if (process.env.NODE_ENV !== 'production') {
  require('dotenv').config({ path: '.env.local' });
}
```

**[SCREENSHOT PLACEHOLDER: AWS Console error messages and their resolutions]**

---

## Migration Checklist

### Pre-Migration
- [ ] Backup current configuration files
- [ ] Document current environment variables
- [ ] Test IAM permissions in non-production environment
- [ ] Create SSM parameters and secrets in staging

### Migration Steps
- [ ] Apply Terraform changes for SSM/Secrets Manager resources
- [ ] Update ECS task definitions with secret references
- [ ] Deploy updated application code
- [ ] Verify all services start successfully
- [ ] Test database connectivity
- [ ] Validate application functionality

### Post-Migration
- [ ] Remove hardcoded secrets from code
- [ ] Update documentation
- [ ] Set up monitoring and alerting
- [ ] Configure secret rotation (if applicable)
- [ ] Train team on new secret management process

### Rollback Plan
- [ ] Keep backup of original task definitions
- [ ] Document rollback steps
- [ ] Test rollback procedure in staging

**[SCREENSHOT PLACEHOLDER: Migration progress dashboard or checklist completion]**

---

## Cost Considerations

### SSM Parameter Store Pricing
- Standard parameters: Free (up to 10,000)
- Advanced parameters: $0.05 per 10,000 requests
- No charges for storage under free tier limits

### Secrets Manager Pricing
- $0.40 per secret per month
- $0.05 per 10,000 requests
- Additional charges for cross-region replication

### Estimated Monthly Costs for This Project
- 5 SSM Parameters: $0 (within free tier)
- 2 Secrets Manager secrets: $0.80
- API calls (estimated 50,000/month): $0.25
- **Total estimated cost: ~$1.05/month**

---

## Next Steps

1. **Implement in Staging First**: Apply these changes to a staging environment before production
2. **Set Up Monitoring**: Configure CloudWatch alarms and EventBridge rules
3. **Plan Secret Rotation**: Implement automatic rotation for database passwords
4. **Team Training**: Ensure team understands new secret management workflow
5. **Documentation Updates**: Update README and operational runbooks

---

## Additional Resources

- [AWS SSM Parameter Store Documentation](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html)
- [AWS Secrets Manager Documentation](https://docs.aws.amazon.com/secretsmanager/)
- [ECS Secrets Management Best Practices](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html)
- [Terraform AWS Provider SSM Resources](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/ssm_parameter)

---

**Document Version**: 1.0  
**Last Updated**: November 1, 2025  
**Author**: DevOps Team